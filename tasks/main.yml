#SPDX-License-Identifier: MIT-0
---

- name: Preflight | show target platform
  ansible.builtin.debug:
    msg: "Managing UDS CLI on ansible_system={{ ansible_system }} ansible_architecture={{ ansible_architecture }} state={{ uds_cli_state | default('present') }}"

- name: macOS | manage via Homebrew
  when: ansible_system == 'Darwin'
  block:
    - name: Preflight | validate uds_cli_state
      ansible.builtin.assert:
        that:
          - uds_cli_state in ['present', 'absent']
        fail_msg: "uds_cli_state must be one of: present, absent (got: {{ uds_cli_state }})"

    - name: macOS | ensure Homebrew is present
      ansible.builtin.include_role:
        name: moltimersmith.brew
      vars:
        # Don't manage taps/formulae here; this include is just to set brew_bin reliably.
        brew_update: false
        brew_taps: []
        brew_formulae: []
        brew_casks: []

    - name: macOS | set uds_bin (same dir as brew)
      ansible.builtin.set_fact:
        uds_bin: "{{ (brew_bin | default('brew') | dirname) ~ '/uds' }}"

    - name: macOS | list installed uds formulae
      ansible.builtin.command: "{{ brew_bin }} list --formula"
      register: brew_formula_list
      changed_when: false

    - name: macOS | compute installed uds formulae
      ansible.builtin.set_fact:
        uds_cli_installed_formulae: >-
          {{
            (brew_formula_list.stdout_lines | default([]))
            | select('match', '^uds(@.+)?$')
            | list
          }}

    - name: macOS | uninstall all uds* formulae (absent)
      community.general.homebrew:
        name: "{{ uds_cli_installed_formulae }}"
        state: absent
        path: "{{ brew_bin | dirname }}"
      when:
        - uds_cli_state == 'absent'
        - (uds_cli_installed_formulae | default([]) | length) > 0

    - name: macOS | ensure taps are present (install path only)
      community.general.homebrew_tap:
        name: "{{ item }}"
        state: present
        path: "{{ brew_bin | dirname }}"
      loop: "{{ uds_cli_brew_taps }}"
      when: uds_cli_state == 'present'

    - name: macOS | uninstall other uds* formulae to avoid brew link conflicts
      community.general.homebrew:
        name: "{{ uds_cli_installed_formulae | difference(uds_cli_brew_formulae) }}"
        state: absent
        path: "{{ brew_bin | dirname }}"
      when:
        - uds_cli_state == 'present'
        - (uds_cli_installed_formulae | default([]) | difference(uds_cli_brew_formulae) | length) > 0

    - name: macOS | install uds (brew)
      community.general.homebrew:
        name: "{{ uds_cli_brew_formulae }}"
        state: present
        path: "{{ brew_bin | dirname }}"
      when: uds_cli_state == 'present'

    - name: macOS | verify uds is installed
      ansible.builtin.command: "{{ uds_bin }} version"
      register: uds_cli_version
      changed_when: false
      when: uds_cli_state == 'present'

    - name: macOS | uds version
      ansible.builtin.debug:
        var: uds_cli_version.stdout
      when: uds_cli_state == 'present'

- name: Linux | placeholder (not implemented)
  when: ansible_system == 'Linux'
  ansible.builtin.fail:
    msg: |
      UDS CLI installation for Linux is not implemented yet in this role.

      Planned approach: install the uds binary (pinned version) via URL/local file + checksum verification.
      For now, run this role only on macOS, or implement the Linux installer block.

- name: Unsupported OS
  when: ansible_system not in ['Darwin', 'Linux']
  ansible.builtin.fail:
    msg: "Unsupported OS for uds_cli role: ansible_system={{ ansible_system }}"
