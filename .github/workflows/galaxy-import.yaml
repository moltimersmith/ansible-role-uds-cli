name: Publish to Ansible Galaxy

on:
  workflow_run:
    workflows: ["Release Please"]
    types: [completed]
  workflow_dispatch:
    inputs:
      github_reference:
        description: "Git ref to import (tag/branch/sha). Defaults to latest tag."
        required: false

permissions:
  contents: read

jobs:
  import:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Determine ref to import
        id: ref
        env:
          INPUT_REF: ${{ github.event.inputs.github_reference }}
        run: |
          set -euo pipefail

          if [ -n "${INPUT_REF:-}" ]; then
            echo "ref=${INPUT_REF}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Use the latest tag in the repo (release-please creates and pushes a tag when it publishes a release)
          git init -q
          git remote add origin "https://github.com/${GITHUB_REPOSITORY}.git"
          git fetch --tags -q origin
          REF=$(git tag --sort=-v:refname | head -n 1)
          if [ -z "${REF}" ]; then
            REF="main"
          fi

          echo "ref=${REF}" >> "$GITHUB_OUTPUT"

      - name: Trigger Ansible Galaxy role import
        env:
          GALAXY_API_TOKEN: ${{ secrets.GALAXY_API_TOKEN }}
          GITHUB_USER: moltimersmith
          GITHUB_REPO: ansible-role-uds-cli
          REF: ${{ steps.ref.outputs.ref }}
        run: |
          set -euo pipefail

          if [ -z "${GALAXY_API_TOKEN}" ]; then
            echo "GALAXY_API_TOKEN secret is not set" >&2
            exit 1
          fi

          echo "Triggering Galaxy import for ${GITHUB_USER}/${GITHUB_REPO} ref=${REF}"

          curl -fsS -X POST "https://galaxy.ansible.com/api/v1/imports/" \
            -H "Content-Type: application/json" \
            -H "Authorization: Token ${GALAXY_API_TOKEN}" \
            -d "{\"github_user\":\"${GITHUB_USER}\",\"github_repo\":\"${GITHUB_REPO}\",\"github_reference\":\"${REF}\"}"
